<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="卓稟鈞(AndrewCho)">
    <meta name="description" content="高雄市公車即時動態查詢">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>高雄交通智慧地圖</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- CSS Libs -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 系統級優化 --- */
        body, html { 
            height: 100%; margin: 0; overflow: hidden; 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f3f4f6;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        #map { 
            height: 100%; width: 100%; z-index: 1; 
            background: #e5e7eb; 
        }
        
        .leaflet-map-pane {
            transform: translate3d(0,0,0);
            will-change: transform;
        }
        
        /* --- 圖釘樣式 --- */
        .custom-icon {
            border-radius: 50%; color: white;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid white; 
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backface-visibility: hidden;
            will-change: transform;
        }
        
        @media (hover: hover) {
            .custom-icon:hover { transform: scale(1.15); z-index: 1000 !important; }
        }

        .bus-icon { background: #2563eb; }
        .ubike-icon { background: #f59e0b; }

        .marker-cluster-bus, .marker-cluster-ubike { background: transparent !important; }
        
        .cluster-content {
            width: 36px; height: 36px;
            border-radius: 50%; color: white; font-weight: bold; font-size: 14px;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            transition: transform 0.2s; will-change: transform;
        }
        
        .bg-bus { background-color: #2563eb; }
        .bg-ubike { background-color: #d97706; }

        /* --- UI Components --- */
        .search-container { 
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; width: 94%; max-width: 400px;
        }
        #search-box {
            background: white; border-radius: 99px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; padding: 0.5rem 1rem;
            transition: transform 0.2s;
        }
        #search-box:active { transform: scale(0.98); }
        
        #search-results {
            background: white; width: 100%; margin-top: 8px; border-radius: 16px;
            max-height: 50vh; overflow-y: auto; display: none;
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.15); border: 1px solid #f3f4f6;
        }
        #search-results.show { display: block; }

        /* --- Sidebar & Layout Logic --- */
        #sidebar {
            position: fixed; z-index: 2000; background: white;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        
        #drag-area { touch-action: none; }
        #sb-content { overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }

        @media (orientation: portrait) {
            #sidebar {
                left: 0; bottom: 0; width: 100%; height: 85vh; 
                border-radius: 28px 28px 0 0; transform: translateY(110%);
                transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1);
            }
            .search-container { width: 94%; }
            body.sidebar-open .search-container { transform: none; }
        }

        @media (orientation: landscape) {
            #sidebar {
                top: 12px; left: 12px; height: calc(100% - 24px); width: 380px;
                transform: translateX(-110%); border-radius: 24px; border: 1px solid #e5e7eb;
                transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                box-shadow: 5px 0 25px rgba(0,0,0,0.1);
            }
            #sidebar.active { transform: translateX(0); }
            
            .search-container { 
                top: 20px; left: 20px; width: 380px; max-width: none;
                transform: none; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            }
            body.sidebar-open .search-container { transform: translateX(410px); }
        }
        
        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        #loading-screen.visible { pointer-events: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-anim { animation: spin 0.8s linear infinite; }

        /* Toast */
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); z-index: 4000; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; width: 90%; max-width: 300px; display: flex; justify-content: center; }
        #toast-container.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-content { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(8px); color: #fff; padding: 10px 20px; border-radius: 99px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; }

        /* Modal */
        #nav-modal { transition: opacity 0.3s ease; }
        #nav-modal.hidden { opacity: 0; pointer-events: none; }
        #nav-modal:not(.hidden) { opacity: 1; pointer-events: auto; }

        /* Iframe Overlay */
        #iframe-overlay {
            position: fixed; inset: 0; z-index: 6000; 
            background: white; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #iframe-overlay.active { transform: translateY(0); }
        
        .tracker-iframe { border: 0; width: 100%; height: 100%; display: block; position: relative; z-index: 10; background: white; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

    <div id="loading-screen" class="visible">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-slate-800">高雄交通智慧地圖</h2>
        <p id="loading-text" class="text-sm text-slate-500 mt-2">系統初始化中...</p>
    </div>

    <div id="toast-container">
        <div id="toast-message" class="toast-content">
            <span id="toast-icon" class="material-icons-round text-lg">info</span>
            <span id="toast-text">提示訊息</span>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="nav-modal" class="fixed inset-0 z-[5000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden p-4" onclick="handleModalClick(event)">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transition-transform scale-100" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons-round text-xl">directions_bus</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-800">查看路線動態</h3>
                </div>
            </div>
            <p class="text-slate-600 mb-6">是否查看 <span id="nav-route-name" class="font-bold text-blue-600">紅53</span> 的詳細動態？</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 px-4 rounded-xl bg-gray-100 text-slate-700 font-bold hover:bg-gray-200 transition">取消</button>
                <button onclick="openTracker()" class="flex-1 py-3 px-4 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">前往</button>
            </div>
        </div>
    </div>

    <!-- Iframe Overlay -->
    <div id="iframe-overlay">
        <div id="iframe-loader" class="absolute inset-0 flex items-center justify-center z-0">
            <div class="loader w-8 h-8 border-2"></div>
        </div>
        <div id="iframe-container" class="w-full h-full relative z-10"></div>
    </div>

    <div class="search-container">
        <div id="search-box">
            <span class="material-icons-outlined text-slate-400 mr-2">search</span>
            <input type="text" id="search-input" placeholder="搜尋公車路線或 YouBike..." class="flex-1 outline-none text-slate-700 placeholder-slate-400 bg-transparent text-base">
            <button id="search-clear" class="hidden p-1 text-slate-300 hover:text-slate-500 rounded-full mr-1 transition"><span class="material-icons-round text-lg">cancel</span></button>
            <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
            <button class="p-2 text-slate-400 hover:text-blue-600 transition" onclick="locateUser()"><span class="material-icons-outlined">my_location</span></button>
        </div>
        <div id="search-results"></div>
    </div>

    <div id="sidebar">
        <div id="drag-area" class="bg-white sticky top-0 z-10 cursor-grab active:cursor-grabbing rounded-t-[28px]">
            <div class="w-full flex justify-center pt-3 pb-1 md:hidden portrait-handle">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-start">
                <div class="flex-1 min-w-0 pr-2">
                    <div id="sb-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 bg-gray-100 text-gray-600">載入中</div>
                    <h2 id="sb-title" class="text-2xl font-bold text-slate-800 truncate">請選擇站點</h2>
                    <p id="sb-subtitle" class="text-sm text-slate-500 truncate mt-1">-</p>
                </div>
                <button id="refresh-btn" onclick="event.stopPropagation(); refreshData()" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-500 hover:bg-blue-50 hover:text-blue-600 rounded-full shadow-sm border border-slate-100 transition"><span class="material-icons-round text-xl">refresh</span></button>
            </div>
        </div>
        <div id="sb-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 space-y-3 pb-safe rounded-b-[28px]"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.21/leaflet-maplibre-gl.js"></script>

    <script>
        const CONFIG = {
            UBIKE_LIST: 'https://apis.youbike.com.tw/json/station-min-yb2.json',
            UBIKE_REALTIME: 'https://apis.youbike.com.tw/tw2/parkingInfo',
            IBUS_API: 'https://ibus.tbkc.gov.tw/ibus/graphql',
            SHORTBREAD_STYLE: 'https://potatosserver.github.io/map/shortbread.json'
        };

        const STATE = {
            map: null, busCluster: null, bikeCluster: null,
            dataBus: [], dataBike: [], markersMap: { bus: {}, bike: {} },
            currentContext: null, pendingRouteId: null, pendingStationId: null, pendingRouteName: null,
            autoRefreshTimer: null, userMarker: null, userAccuracy: null, geoWatcherId: null,
            userPos: null, 
            sheetState: 'hidden'
        };

        const isPortrait = () => window.innerHeight > window.innerWidth;

        function preprocessStyle(style) {
            if (!style || !style.layers) return style;
            for (const layer of style.layers) {
                if (layer.layout && layer.layout['text-field']) {
                    layer.layout['text-field'] = ['coalesce', ['get', 'name:zh-Hant'], ['get', 'name:zh'], ['get', 'name:en'], ['get', 'name']];
                }
            }
            return style;
        }

        window.onload = async () => {
            await initMap();
            initSidebarGestures();
            Promise.all([loadBusData(), loadBikeData()]).then(() => {
                const loading = document.getElementById('loading-screen');
                loading.style.opacity = '0';
                loading.classList.remove('visible');
                setTimeout(() => loading.remove(), 500);
            });
            initialLocateUser(); 
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(e=>{});
            
            window.addEventListener('resize', () => {
                if (STATE.sheetState !== 'hidden') {
                    setSidebarState(isPortrait() ? 'half' : 'active');
                }
            });
        };

        function updateLoading(txt) { document.getElementById('loading-text').innerText = txt; }
        
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const icon = document.getElementById('toast-icon');
            document.getElementById('toast-text').innerText = msg;
            icon.innerText = type === 'error' ? 'error' : (type === 'success' ? 'check_circle' : 'info');
            icon.className = `material-icons-round text-xl ${type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-blue-400')}`;
            container.classList.add('show');
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { container.classList.remove('show'); }, 3000);
        }

        // --- Navigation Logic ---
        function confirmRedirect(routeId, routeName, stationId) {
            STATE.pendingRouteId = routeId; 
            STATE.pendingStationId = stationId;
            STATE.pendingRouteName = routeName;
            document.getElementById('nav-route-name').innerText = routeName;
            document.getElementById('nav-modal').classList.remove('hidden');
            history.pushState({ modal: 'confirm' }, null, '');
        }

        function closeModal() {
            history.back();
        }

        function openTracker() {
            if (STATE.pendingRouteId) {
                const url = `https://kaohsiung-live-bus.pages.dev/?page=tracker&route=${STATE.pendingRouteId}${STATE.pendingStationId ? '&station='+STATE.pendingStationId : ''}`;
                
                const container = document.getElementById('iframe-container');
                container.innerHTML = ''; 
                const iframe = document.createElement('iframe');
                iframe.className = 'tracker-iframe';
                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
                iframe.src = url;
                container.appendChild(iframe);
                document.getElementById('nav-modal').classList.add('hidden');
                document.getElementById('iframe-overlay').classList.add('active');
                history.replaceState({ modal: 'iframe' }, null, '');
            }
        }

        window.addEventListener('popstate', (e) => {
            const modal = document.getElementById('nav-modal');
            const iframeOverlay = document.getElementById('iframe-overlay');
            const container = document.getElementById('iframe-container');

            if (!e.state || e.state.modal !== 'confirm') {
                if (!modal.classList.contains('hidden')) modal.classList.add('hidden');
            }
            if (!e.state || e.state.modal !== 'iframe') {
                if (iframeOverlay.classList.contains('active')) {
                    iframeOverlay.classList.remove('active');
                    setTimeout(() => { container.innerHTML = ''; }, 300);
                }
            }
            if (e.state?.modal === 'confirm') modal.classList.remove('hidden');
            if (e.state?.modal === 'iframe') iframeOverlay.classList.add('active');
        });

        // --- Logic ---
        function startAutoRefresh() { stopAutoRefresh(); if (STATE.currentContext) STATE.autoRefreshTimer = setInterval(() => { if (STATE.sheetState !== 'hidden') refreshData(true); else stopAutoRefresh(); }, 30000); }
        function stopAutoRefresh() { if (STATE.autoRefreshTimer) { clearInterval(STATE.autoRefreshTimer); STATE.autoRefreshTimer = null; } }

        function updateUserLocation(pos) {
            const { latitude, longitude, accuracy } = pos.coords;
            STATE.userPos = [latitude, longitude]; 
            
            if (STATE.userAccuracy) STATE.map.removeLayer(STATE.userAccuracy);
            if (STATE.userMarker) STATE.map.removeLayer(STATE.userMarker);
            STATE.userAccuracy = L.circle([latitude, longitude], { radius: accuracy, color: '#3b82f6', fillOpacity: 0.1 }).addTo(STATE.map);
            STATE.userMarker = L.marker([latitude, longitude], { icon: L.divIcon({ className: 'bg-blue-600 border-2 border-white rounded-full shadow-lg', iconSize: [14, 14] }) }).addTo(STATE.map);
        }

        function startWatcher() {
            if (STATE.geoWatcherId) return; 
            if (navigator.geolocation) {
                STATE.geoWatcherId = navigator.geolocation.watchPosition(
                    (pos) => { updateUserLocation(pos); }, 
                    (err) => { }, 
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
            }
        }

        function initialLocateUser() {
            startWatcher();
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    updateUserLocation(pos); 
                    STATE.map.flyTo([pos.coords.latitude, pos.coords.longitude], 17, { animate: true, duration: 0.8 }); 
                }, 
                (err) => {}, 
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function locateUser() {
            if (!navigator.geolocation) return showToast('不支援定位', 'error');
            startWatcher();
            if (STATE.userPos) {
                STATE.map.flyTo(STATE.userPos, 17, { animate: true, duration: 0.8 });
                showToast('已定位至目前位置');
            } else {
                showToast('定位中...');
                navigator.geolocation.getCurrentPosition(
                    (pos) => { 
                        updateUserLocation(pos); 
                        STATE.map.flyTo([pos.coords.latitude, pos.coords.longitude], 17, { animate: true, duration: 0.8 }); 
                    },
                    () => { showToast('無法取得位置', 'error'); },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        async function fetchGraphQL(query, variables) {
            try { 
                const res = await fetch(CONFIG.IBUS_API, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Origin': 'https://ibus.tbkc.gov.tw' }, 
                    body: JSON.stringify({ query, variables })
                });
                return await res.json(); 
            } catch (e) { throw e; }
        }

        async function refreshData(isAuto = false) { 
            if (!STATE.currentContext) return;
            const btnIcon = document.querySelector('#refresh-btn span');
            if (!isAuto && btnIcon) btnIcon.classList.add('spin-anim');
            const { type, data } = STATE.currentContext;
            const content = document.getElementById('sb-content');
            if (type === 'bus') renderBusContent(await getBusArrivals(data.id), content);
            else renderBikeContent(await getBikeRealtime(data.station_no), content);
            if (!isAuto && btnIcon) setTimeout(() => { btnIcon.classList.remove('spin-anim'); showToast('資料已更新', 'success'); }, 600);
        }

        async function initMap() {
            STATE.map = L.map('map', { 
                zoomControl: false, maxZoom: 22, preferCanvas: true, wheelDebounceTime: 100 
            }).setView([22.631442, 120.301890], 17);

            try {
                const response = await fetch(CONFIG.SHORTBREAD_STYLE);
                let style = preprocessStyle(await response.json());
                L.maplibreGL({
                    style: style,
                    maplibreGLOptions: { crossOrigin: 'anonymous', fadeDuration: 0, localIdeographFontFamily: "'Noto Sans TC', sans-serif" },
                    padding: 0.1, attribution: '&copy; OpenStreetMap'
                }).addTo(STATE.map);
            } catch (error) { console.error(error); }

            L.control.zoom({ position: 'bottomright' }).addTo(STATE.map);
            STATE.map.on('click', () => setSidebarState('hidden'));

            const clusterOptions = (className, colorClass) => ({
                disableClusteringAtZoom: 17, showCoverageOnHover: false, maxClusterRadius: 60,
                chunkedLoading: true, chunkInterval: 200, chunkDelay: 50,
                updateWhenIdle: true, animate: true, 
                spiderfyOnMaxZoom: true, removeOutsideVisibleBounds: true,
                iconCreateFunction: (c) => L.divIcon({ 
                    html: `<div class="cluster-content ${colorClass}">${c.getChildCount()}</div>`, 
                    className: `marker-cluster ${className}`, 
                    iconSize: [40, 40] 
                })
            });

            STATE.busCluster = L.markerClusterGroup(clusterOptions('marker-cluster-bus', 'bg-bus'));
            STATE.bikeCluster = L.markerClusterGroup(clusterOptions('marker-cluster-ubike', 'bg-ubike'));
            STATE.map.addLayer(STATE.busCluster);
            STATE.map.addLayer(STATE.bikeCluster);
        }

        async function fetchBusStationsGodMode() {
            const uniqueStations = new Map();
            try {
                const listData = await fetchGraphQL(`query { routes(lang: "zh") { edges { node { id } } } }`);
                const allRoutes = listData.data.routes.edges;
                const bigQueryBody = allRoutes.map(edge => `r_${edge.node.id}: route(xno: ${edge.node.id}, lang: "zh") { stations { edges { node { id name lat lon } } } }`).join('\n');
                const result = await fetchGraphQL(`query GOD_MODE_FETCH { ${bigQueryBody} }`);
                if (result.data) Object.values(result.data).forEach(r => r?.stations?.edges.forEach(e => uniqueStations.set(e.node.id, e.node)));
                return Array.from(uniqueStations.values());
            } catch (e) { return []; }
        }

        async function loadBusData() {
            STATE.dataBus = await fetchBusStationsGodMode(); 
            const markers = STATE.dataBus.map(s => {
                if(!s.lat || !s.lon) return null;
                const marker = L.marker([s.lat, s.lon], { icon: L.divIcon({ 
                    className: 'custom-icon bus-icon', 
                    html: '<i class="material-icons-outlined" style="font-size:18px;">directions_bus</i>', 
                    iconSize: [30, 30] 
                }) });
                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bus', s); });
                STATE.markersMap.bus[s.id] = marker;
                return marker;
            }).filter(m => m);
            STATE.busCluster.addLayers(markers);
        }

        async function loadBikeData() {
            try {
                const data = (await (await fetch(CONFIG.UBIKE_LIST)).json()).filter(s => s.lat > 22.4 && s.lat < 23.0 && s.lng > 120.1 && s.lng < 120.8);
                STATE.dataBike = data;
                const markers = data.map(s => {
                    const marker = L.marker([s.lat, s.lng], { icon: L.divIcon({ 
                        className: 'custom-icon ubike-icon', 
                        html: '<i class="material-icons-round" style="font-size:18px;">pedal_bike</i>', 
                        iconSize: [30, 30] 
                    }) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bike', s); });
                    STATE.markersMap.bike[s.station_no] = marker;
                    return marker;
                }).filter(m => m);
                STATE.bikeCluster.addLayers(markers);
            } catch (e) {}
        }

        function handleMarkerClick(marker, type, data) {
            // [修正] 使用目前的 zoom level，不強制縮放
            STATE.map.flyTo(marker.getLatLng(), STATE.map.getZoom(), { animate: true, duration: 0.8 });
            openSidebar(type, data);
        }

        function setSidebarState(newState) {
            const sb = document.getElementById('sidebar');
            STATE.sheetState = newState;
            
            if (!isPortrait()) {
                if (newState === 'hidden') { sb.classList.remove('active'); document.body.classList.remove('sidebar-open'); stopAutoRefresh(); }
                else { sb.classList.add('active'); document.body.classList.add('sidebar-open'); }
            } else {
                const h = sb.offsetHeight;
                sb.style.transform = newState === 'full' ? `translateY(0px)` : (newState === 'half' ? `translateY(${Math.max(0, h - window.innerHeight * 0.45)}px)` : `translateY(110%)`);
                if (newState === 'hidden') stopAutoRefresh();
            }
        }

        function initSidebarGestures() {
            const sidebar = document.getElementById('sidebar');
            const dragArea = document.getElementById('drag-area');
            let startY = 0, startTransformY = 0, isDragging = false;
            
            dragArea.addEventListener('touchstart', (e) => {
                if (!isPortrait() || e.target.closest('button')) return;
                startY = e.touches[0].clientY; 
                startTransformY = (new WebKitCSSMatrix(window.getComputedStyle(sidebar).transform)).m42; 
                isDragging = true; 
                sidebar.style.transition = 'none';
            }, { passive: true });

            dragArea.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                let newY = startTransformY + (e.touches[0].clientY - startY);
                if (newY < 0) newY *= 0.4; 
                sidebar.style.transform = `translateY(${newY}px)`;
            }, { passive: true });

            dragArea.addEventListener('touchend', (e) => {
                if (!isDragging) return; isDragging = false;
                const diff = e.changedTouches[0].clientY - startY;
                if (STATE.sheetState === 'full') {
                    setSidebarState(diff > 150 ? (diff > 300 ? 'hidden' : 'half') : 'full');
                } else {
                    setSidebarState(diff < -60 ? 'full' : (diff > 60 ? 'hidden' : 'half'));
                }
            });
        }

        async function openSidebar(type, data) {
            STATE.currentContext = { type, data };
            const content = document.getElementById('sb-content');
            const badge = document.getElementById('sb-badge');
            document.getElementById('sb-title').innerText = type === 'bus' ? data.name : data.name_tw;
            document.getElementById('sb-subtitle').innerText = type === 'bus' ? `ID: ${data.id}` : data.address_tw;
            content.innerHTML = `<div class="animate-pulse space-y-4"><div class="h-24 bg-gray-200 rounded-2xl"></div><div class="h-12 bg-gray-200 rounded-xl"></div></div>`;
            
            badge.className = `inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 ${type === 'bus' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}`;
            badge.innerHTML = type === 'bus' ? '<span class="material-icons-outlined text-sm mr-1">directions_bus</span> 公車' : '<span class="material-icons-round text-sm mr-1">pedal_bike</span> YouBike 2.0';
            
            if (type === 'bus') renderBusContent(await getBusArrivals(data.id), content);
            else renderBikeContent(await getBikeRealtime(data.station_no), content);
            
            setSidebarState(isPortrait() ? 'half' : 'active');
            startAutoRefresh();
        }

        function renderBusContent(data, container) {
            if (!data) return container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-center text-sm">連線失敗</div>';
            if (data.length === 0) return container.innerHTML = '<div class="p-8 text-center text-slate-400"><p>無營運路線</p></div>';
            let html = '<div class="space-y-3">';
            data.forEach(r => {
                let timeHtml = `<span class="text-gray-400 font-bold text-sm">未發車</span>`;
                let statusClass = 'bg-white border-gray-100';
                if (r.isSuspended) timeHtml = `<span class="text-gray-500 text-sm">末班已過</span>`;
                else if (r.etas?.[0]) {
                    const min = r.etas[0].etaTime;
                    if (min <= 1) { timeHtml = `<span class="text-red-600 font-bold text-sm">進站中</span>`; statusClass = 'bg-red-50 border-red-100'; }
                    else timeHtml = `<span class="text-blue-600 font-bold text-lg">${min} <span class="text-xs text-slate-500">分</span></span>`;
                } else if (r.comeTime) timeHtml = `<span class="text-slate-600 font-medium text-sm">${r.comeTime}</span>`;
                html += `<div onclick="confirmRedirect('${r.id}', '${r.name}', '${STATE.currentContext.data.id}')" class="p-3 rounded-2xl border ${statusClass} flex justify-between items-center bg-white cursor-pointer active:scale-95 transition"><div class="flex-1 min-w-0 mr-3"><div class="flex items-center gap-2"><span class="text-lg font-bold text-slate-800 truncate">${r.name}</span><span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full flex-shrink-0">${r.dir}</span></div></div><div class="text-right">${timeHtml}</div></div>`;
            });
            container.innerHTML = html + '</div>';
        }

        function renderBikeContent(info, container) {
            if (!info) return container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 text-center">無法取得資料</div>';
            const { yb2, eyb } = info.available_spaces_detail;
            const empty = info.empty_spaces;
            const time = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
            const getNumColor = (n) => n > 3 ? 'text-slate-800' : (n > 0 ? 'text-orange-600' : 'text-gray-300');

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-3xl shadow-sm border border-amber-200 relative overflow-hidden flex flex-col justify-between h-28">
                            <div class="z-10"><span class="text-xs font-bold text-amber-700 uppercase tracking-wider block mb-1">一般車輛</span><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(yb2)}">${yb2}</span><span class="text-xs text-amber-800 ml-1 font-medium">輛</span></div></div>
                            <span class="material-icons-round absolute right-0 bottom-0 text-7xl text-amber-400 opacity-20">pedal_bike</span>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-3xl shadow-sm border border-orange-200 relative overflow-hidden flex flex-col justify-between h-28">
                            <div class="z-10"><div class="flex items-center justify-between mb-1"><span class="text-xs font-bold text-orange-700 uppercase tracking-wider">電輔車</span><span class="material-icons-round text-xs text-orange-600">bolt</span></div><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(eyb)}">${eyb}</span><span class="text-xs text-orange-800 ml-1 font-medium">輛</span></div></div>
                            <span class="material-icons-round absolute right-0 bottom-0 text-7xl text-orange-400 opacity-20">electric_bike</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-teal-100 p-5 rounded-3xl shadow-sm border border-emerald-200 flex justify-between items-center relative overflow-hidden">
                        <div class="relative z-10"><div class="text-xs text-emerald-800 mb-1 font-bold uppercase tracking-wider">可歸還空位</div><div class="font-bold text-lg text-emerald-900">停車柱</div></div>
                        <div class="text-5xl font-black text-emerald-600 relative z-10">${empty}</div>
                        <span class="material-icons-outlined absolute right-0 top-0 text-9xl text-emerald-500 opacity-10 transform translate-x-4 -translate-y-2 pointer-events-none">local_parking</span>
                    </div>
                    <div class="text-center text-xs text-slate-400 mt-2 flex justify-center items-center gap-1"><span class="material-icons-outlined text-sm">schedule</span> 更新於 ${time}</div>
                </div>`;
        }

        async function getBusArrivals(stationId) {
            try {
                const j1 = await fetchGraphQL(`query Q($ids:[Int!]!){stations(lang:"zh",ids:$ids){edges{node{... on Station{routes{edges{goBack node{id name}}}}}}}}`, { ids: [parseInt(stationId)] });
                const routeEdges = j1?.data?.stations?.edges?.[0]?.node?.routes?.edges || [];
                if (!routeEdges.length) return [];
                const targets = routeEdges.map(e => ({ xno: parseInt(e.node.id), goBack: parseInt(e.goBack), stationId: parseInt(stationId) }));
                const j2 = await fetchGraphQL(`query T($t:[EstimateStationInput!]!){stationEstimates(targets:$t){edges{node{comeTime isSuspended etas{etaTime}}}}}`, { t: targets });
                return routeEdges.map((e, i) => ({ id: e.node.id, name: e.node.name, dir: e.goBack === 1 ? '去程' : '返程', ...j2.data.stationEstimates.edges[i]?.node }));
            } catch { return null; }
        }
        async function getBikeRealtime(id) { try { return (await (await fetch(CONFIG.UBIKE_REALTIME, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ station_no: [id] }) })).json()).retVal?.data?.[0]; } catch { return null; } }

        const searchInput = document.getElementById('search-input'), resultsBox = document.getElementById('search-results'), searchClear = document.getElementById('search-clear');
        
        // [修改] 觸發邏輯：input (輸入時), focus (點擊/選取時), click (再次點擊時)
        const handleSearchTrigger = () => {
            const val = searchInput.value.trim().toLowerCase();
            searchClear.classList.toggle('hidden', val.length === 0);
            // 只要有文字就顯示，不管是不是變更
            if(val) doSearch(val); else resultsBox.classList.remove('show');
        };

        searchInput.addEventListener('input', handleSearchTrigger);
        searchInput.addEventListener('focus', handleSearchTrigger);
        searchInput.addEventListener('click', handleSearchTrigger);

        searchClear.addEventListener('click', () => { searchInput.value = ''; searchClear.classList.add('hidden'); resultsBox.classList.remove('show'); });
        
        function calculateScore(text, key) {
            if (!text) return 0;
            const t = text.toString().toLowerCase();
            const k = key.toLowerCase();
            if (t === k) return 1000; 
            if (t.startsWith(k)) return 500 - t.length; 
            const idx = t.indexOf(k);
            if (idx > -1) return 100 - idx; 
            return 0; 
        }

        function doSearch(key) {
            resultsBox.innerHTML = ''; const all = [];
            [...STATE.dataBus, ...STATE.dataBike].forEach(s => {
                const name = s.id ? s.name : s.name_tw; 
                const sub = s.id ? s.id.toString() : s.address_tw;
                
                const nameScore = calculateScore(name, key);
                const subScore = calculateScore(sub, key);
                const maxScore = Math.max(nameScore, subScore);

                if (maxScore > 0) {
                    all.push({ data: s, type: s.id ? 'bus' : 'bike', score: maxScore });
                }
            });

            all.sort((a, b) => b.score - a.score);
            const res = all.slice(0, 15);

            if(!res.length) resultsBox.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">無結果</div>';
            else res.forEach(r => {
                const div = document.createElement('div');
                div.className = 'p-3 flex items-center hover:bg-slate-50 cursor-pointer border-b border-gray-50';
                div.innerHTML = `<div class="w-10 h-10 rounded-full ${r.type==='bus'?'bg-blue-100 text-blue-600':'bg-amber-100 text-amber-600'} flex items-center justify-center mr-3 shrink-0"><span class="material-icons-outlined text-lg">${r.type==='bus'?'directions_bus':'pedal_bike'}</span></div><div class="min-w-0"><div class="font-bold text-slate-700 text-sm truncate">${r.type==='bus'?r.data.name:r.data.name_tw}</div><div class="text-xs text-slate-400 truncate">${r.type==='bus'?'ID: '+r.data.id:r.data.address_tw}</div></div>`;
                div.onclick = () => {
                    resultsBox.classList.remove('show'); searchInput.value = r.type==='bus'?r.data.name:r.data.name_tw; searchClear.classList.remove('hidden');
                    const cluster = r.type==='bus'?STATE.busCluster:STATE.bikeCluster;
                    const marker = STATE.markersMap[r.type][r.type==='bus'?r.data.id:r.data.station_no];
                    if(marker) cluster.zoomToShowLayer(marker, () => handleMarkerClick(marker, r.type, r.data));
                    else { STATE.map.setView([r.type==='bus'?r.data.lat:r.data.lat, r.type==='bus'?r.data.lon:r.data.lng], 18); openSidebar(r.type, r.data); }
                };
                resultsBox.appendChild(div);
            });
            resultsBox.classList.add('show');
        }
        document.addEventListener('click', (e) => { if (!document.querySelector('.search-container').contains(e.target)) resultsBox.classList.remove('show'); });
    </script>
</body>
</html>
