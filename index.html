<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="å“ç¨Ÿéˆ(AndrewCho)">
    <meta name="description" content="ä¸€å€‹å°ˆç‚ºé«˜é›„å¸‚çš„ç°¡å–®ã€ç¾è§€ä¸”ä½æµé‡çš„æ•´åˆå¼å¤§çœ¾é‹è¼¸æœå°‹å™¨ï¼Œæä¾›å¿«é€ŸæŸ¥è©¢è·¯ç·šè³‡è¨ŠåŠŸèƒ½ï¼Œæ»¿è¶³å³æ™‚éœ€æ±‚ï¼Œé©åˆæ‰€æœ‰ç”¨æˆ¶ä½¿ç”¨ã€‚">
    <meta name="keywords" content="é«˜é›„å¸‚å…¬è»Š, é«˜é›„å…¬è»Š, é«˜é›„å¸‚å…¬è»Šå³æ™‚è³‡è¨Š, å…¬è»Šå³æ™‚è³‡è¨Š, å…¬è»Šå¼å°é»ƒ, å…¬è»Šå°é»ƒ, å¹¹ç·š, å¹¹ç·šå…¬è»Š, å¿«ç·š, å¿«ç·šå…¬è»Š, ç´…ç·šå…¬è»Š, æ©˜ç·šå…¬è»Š, é»ƒç·šå…¬è»Š, ç¶ ç·šå…¬è»Š, Github, github.io" />
    <meta property="og:site_name" content="é«˜é›„äº¤é€šæ™ºæ…§åœ°åœ–" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é«˜é›„äº¤é€šæ™ºæ…§åœ°åœ–</title>
    
    <!-- Favicon Settings -->
    <link rel="shortcut icon" href="/icons/icon.ico" type="image/x-icon">
    <link rel="icon" href="/icons/icon.ico" type="image/x-icon">
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é«˜é›„äº¤é€š">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* å…¨åŸŸè¨­å®šï¼šç¦æ­¢é¸å–æ–‡å­— */
        body, html { 
            height: 100%; margin: 0; overflow: hidden; 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f3f4f6;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { 
            height: 100%; width: 100%; z-index: 1; 
            will-change: transform;
        }

        /* --- åœ–é‡˜èˆ‡èšåˆæ¨£å¼ --- */
        .custom-icon {
            border-radius: 50%; color: white;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4); 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            will-change: transform;
        }
        .custom-icon:hover { transform: scale(1.2); z-index: 1000 !important; }
        .bus-icon { background: #2563eb; }
        .ubike-icon { background: #f59e0b; }

        .marker-cluster-bus { background-color: rgba(59, 130, 246, 0.5) !important; }
        .marker-cluster-bus div { background-color: #1d4ed8 !important; color: white !important; border-radius: 50%; width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; line-height: 30px; font-weight: bold; }
        .marker-cluster-ubike { background-color: rgba(245, 158, 11, 0.5) !important; }
        .marker-cluster-ubike div { background-color: #d97706 !important; color: white !important; border-radius: 50%; width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; line-height: 30px; font-weight: bold; }

        /* --- æœå°‹æ¬„ --- */
        .search-container { 
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; width: 94%; max-width: 400px;
        }
        
        #search-box {
            background: white; border-radius: 99px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex; align-items: center; padding: 0.5rem 1rem;
            transition: all 0.3s;
        }

        #search-results {
            background: white; width: 100%; margin-top: 8px; border-radius: 16px;
            max-height: 50vh; overflow-y: auto; display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
        }
        #search-results.show { display: block; }

        /* --- å´é‚Šæ¬„èˆ‡ RWD --- */
        #sidebar {
            position: fixed; z-index: 2000; 
            box-shadow: 0 0 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        #sidebar-header {
            flex-shrink: 0;
            position: sticky; top: 0; z-index: 10;
            background: white; 
        }

        #sb-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* ç›´å‘è¢å¹• (é«˜åº¦ > å¯¬åº¦) */
        @media (orientation: portrait) {
            #sidebar {
                left: 0; bottom: 0; width: 100%; 
                height: 0;
                border-radius: 28px 28px 0 0;
                transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            }
            #sidebar-header {
                 border-radius: 28px 28px 0 0;
                 touch-action: none;
            }
        }

        /* æ©«å‘è¢å¹• (å¯¬åº¦ > é«˜åº¦) */
        @media (orientation: landscape) {
            #drag-area { display: none; }
            #sidebar {
                top: 12px; left: 12px; height: calc(100% - 24px); width: 380px;
                transform: translateX(-110%);
                border-radius: 24px; border: 1px solid #e5e7eb;
                transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            }
            #sidebar.active { transform: translateX(0); }
             #sidebar-header {
                 border-radius: 24px 24px 0 0;
            }

            .search-container {
                top: 20px; left: 20px; width: 380px; max-width: none;
                transform: none; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            }
            body.sidebar-open .search-container { transform: translateX(410px); }
        }
        
        /* è¼‰å…¥å‹•ç•« */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        #loading-screen.visible { pointer-events: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-anim { animation: spin 0.8s linear infinite; }

        /* Toast é€šçŸ¥ */
        #toast-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            z-index: 4000; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;
            width: 90%; max-width: 300px; display: flex; justify-content: center;
        }
        #toast-container.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            color: #1e293b; padding: 10px 20px; border-radius: 99px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0;
        }

        /* è·³è½‰ç¢ºèªå½ˆçª— */
        #nav-modal { transition: opacity 0.3s ease; }
        #nav-modal.hidden { opacity: 0; pointer-events: none; }
        #nav-modal:not(.hidden) { opacity: 1; pointer-events: auto; }

        /* å…§åµŒç€è¦½å™¨/Iframe Modal æ¨£å¼ */
        #iframe-modal { transition: opacity 0.3s ease; z-index: 5000; }
        #iframe-modal.hidden { opacity: 0; pointer-events: none; }
        #iframe-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        #iframe-content { 
            width: 100%; 
            flex-grow: 1; 
            border: none; 
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading-screen" class="visible">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-slate-800">é«˜é›„äº¤é€šæ™ºæ…§åœ°åœ–</h2>
        <p id="loading-text" class="text-sm text-slate-500 mt-2">ç³»çµ±åˆå§‹åŒ–ä¸­ï¼ˆ1/3ï¼‰</p>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast-container">
        <div id="toast-message" class="toast-content">
            <span id="toast-icon" class="material-icons-round text-lg">info</span>
            <span id="toast-text">æç¤ºè¨Šæ¯</span>
        </div>
    </div>
    
    <!-- 1. è·³è½‰ç¢ºèªå½ˆçª— (Bus Route Confirmation Modal) -->
    <div id="nav-modal" class="fixed inset-0 z-[5000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden p-4" onclick="handleModalClick(event)">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons-round text-xl">directions_bus</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-800">æŸ¥çœ‹è·¯ç·šå‹•æ…‹</h3>
                    <p class="text-sm text-slate-500">å°‡é–‹å•Ÿå…§åµŒå‹•æ…‹é é¢</p>
                </div>
            </div>
            <p class="text-slate-600 mb-6">
                æ˜¯å¦æŸ¥çœ‹ <span id="nav-route-name" class="font-bold text-blue-600">ç´…53</span> çš„è©³ç´°å‹•æ…‹ï¼Ÿ
            </p>
            <div class="flex gap-3">
                <button onclick="cancelRedirect()" class="flex-1 py-3 px-4 rounded-xl bg-gray-100 text-slate-700 font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button onclick="doRedirect()" class="flex-1 py-3 px-4 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">å‰å¾€</button>
            </div>
        </div>
    </div>
    
    <!-- 2. å…§åµŒç€è¦½å™¨å½ˆçª— (Iframe Modal) -->
    <div id="iframe-modal" class="fixed inset-0 bg-white hidden flex flex-col">
        <div class="h-14 bg-white border-b border-gray-100 flex items-center px-4 md:px-6 shadow-sm flex-shrink-0">
            <button onclick="closeIframeModal()" class="text-slate-500 hover:text-slate-800 transition mr-4">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <h3 id="iframe-title" class="text-lg font-bold text-slate-800 truncate flex-1">å…¬è»Šè·¯ç·šå‹•æ…‹</h3>
        </div>
        <iframe id="iframe-content" src="" allow="geolocation" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals"></iframe>
    </div>

    <!-- æœå°‹æ¬„ -->
    <div class="search-container">
        <div id="search-box">
            <span class="material-icons-outlined text-slate-400 mr-2">search</span>
            <input type="text" id="search-input" placeholder="æœå°‹å…¬è»Šè·¯ç·šæˆ– YouBike..." 
                   class="flex-1 outline-none text-slate-700 placeholder-slate-400 bg-transparent text-base">
            
            <button id="search-clear" class="hidden p-1 text-slate-300 hover:text-slate-500 hover:bg-slate-100 rounded-full transition mr-1 flex items-center justify-center">
                <span class="material-icons-round text-lg">cancel</span>
            </button>
            
            <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
            
            <button class="p-2 text-slate-400 hover:text-blue-600 transition" onclick="locateUser()" title="å®šä½">
                <span class="material-icons-outlined">my_location</span>
            </button>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- å´é‚Šæ¬„ -->
    <div id="sidebar" class="bg-slate-50">
        <div id="sidebar-header" class="cursor-grab active:cursor-grabbing">
            <div id="drag-area">
                <div class="w-full flex justify-center pt-3 pb-1">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                </div>
            </div>
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-start">
                <div class="flex-1 min-w-0 pr-2">
                    <div id="sb-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 transition-colors bg-gray-100 text-gray-600">è¼‰å…¥ä¸­</div>
                    <h2 id="sb-title" class="text-2xl font-bold text-slate-800 leading-tight truncate">è«‹é¸æ“‡ç«™é»</h2>
                    <div class="flex items-center mt-1 text-slate-500">
                        <span class="material-icons-outlined text-sm mr-1">place</span>
                        <p id="sb-subtitle" class="text-sm truncate">-</p>
                    </div>
                </div>
                <button id="refresh-btn" onclick="refreshData()" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-500 hover:bg-blue-50 hover:text-blue-600 rounded-full transition shadow-sm border border-slate-100" title="æ›´æ–°å³æ™‚è³‡æ–™">
                    <span class="material-icons-round text-xl">refresh</span>
                </button>
            </div>
        </div>
        <div id="sb-content" class="bg-slate-50 p-4 space-y-3 pb-safe rounded-b-[28px]"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const CONFIG = {
            UBIKE_LIST: 'https://apis.youbike.com.tw/json/station-min-yb2.json',
            UBIKE_REALTIME: 'https://apis.youbike.com.tw/tw2/parkingInfo',
            IBUS_API: 'https://ibus.tbkc.gov.tw/ibus/graphql',
            TRACKER_BASE: 'https://kaohsiung-live-bus.pages.dev/?page=tracker'
        };

        const STATE = {
            map: null, busCluster: null, bikeCluster: null,
            dataBus: [], dataBike: [], markersMap: { bus: {}, bike: {} },
            currentContext: null, 
            pendingRouteId: null, 
            pendingStationId: null,
            autoRefreshTimer: null,
            userMarker: null, userAccuracy: null,
            geoWatcherId: null
        };
        
        const LOCATE_ICON_ELEMENT = document.querySelector('#search-box button:last-child span');

        // RESTRUCTURED: window.onload now separates initial location from continuous tracking
        window.onload = async () => {
            initMap();
            initSidebarGestures();

            // 1. Perform the one-time, silent location attempt on load
            initialLocate(); 
            
            await loadBusData();
            await loadBikeData();
            
            // 2. Start the continuous background tracking (will run silently if permission is granted)
            startContinuousGeolocation(); 

            const loading = document.getElementById('loading-screen');
            loading.style.opacity = '0';
            loading.classList.remove('visible');
            setTimeout(() => loading.remove(), 500);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered!', reg))
                    .catch(err => console.error('Service Worker Registration Failed:', err));
            }
        };

        function updateLoading(txt) { document.getElementById('loading-text').innerText = txt; }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const text = document.getElementById('toast-text');
            const icon = document.getElementById('toast-icon');
            text.innerText = msg;
            
            if (type === 'error') { icon.innerText = 'error'; icon.className = 'material-icons-round text-red-500 text-xl'; } 
            else if (type === 'success') { icon.innerText = 'check_circle'; icon.className = 'material-icons-round text-green-500 text-xl'; } 
            else { icon.innerText = 'info'; icon.className = 'material-icons-round text-blue-500 text-xl'; }

            container.classList.add('show');
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { container.classList.remove('show'); }, 3000);
        }

        // --- å½ˆçª—èˆ‡è·³è½‰é‚è¼¯ ---
        function handleModalClick(event) {
            if (event.target.id === 'nav-modal') {
                cancelRedirect();
            }
        }

        function confirmRedirect(routeId, routeName, stationId) {
            STATE.pendingRouteId = routeId;
            STATE.pendingStationId = stationId;
            document.getElementById('nav-route-name').innerText = routeName;
            document.getElementById('nav-modal').classList.remove('hidden');
            history.pushState({ modal: 'nav' }, null, '');
        }

        function doRedirect() {
            const modal = document.getElementById('nav-modal');
            const iframeModal = document.getElementById('iframe-modal');
            const iframe = document.getElementById('iframe-content');
            const title = document.getElementById('iframe-title');
            
            modal.classList.add('hidden');
            
            const routeName = document.getElementById('nav-route-name').innerText;
            title.innerText = `${routeName} è·¯ç·šå‹•æ…‹`;

            let url = `${CONFIG.TRACKER_BASE}&route=${STATE.pendingRouteId}`;
            if (STATE.pendingStationId) {
                url += `&station=${STATE.pendingStationId}`;
            }

            iframe.src = url;
            iframeModal.classList.remove('hidden');

            history.pushState({ modal: 'iframe' }, null, '');
        }

        function cancelRedirect() { history.back(); }

        function closeIframeModal() {
            history.back(); 
        }
        
        window.addEventListener('popstate', (e) => {
            const navModal = document.getElementById('nav-modal');
            const iframeModal = document.getElementById('iframe-modal');

            if (!iframeModal.classList.contains('hidden')) {
                iframeModal.classList.add('hidden');
                document.getElementById('iframe-content').src = ''; 
            }
            else if (!navModal.classList.contains('hidden')) {
                navModal.classList.add('hidden');
                STATE.pendingRouteId = null;
                STATE.pendingStationId = null;
            }
        });

        // --- è‡ªå‹•æ›´æ–°é‚è¼¯ ---
        function startAutoRefresh() {
            stopAutoRefresh(); 
            if (!STATE.currentContext) return;
            STATE.autoRefreshTimer = setInterval(() => {
                const sidebarActive = document.getElementById('sidebar').classList.contains('active');
                const modalHidden = document.getElementById('nav-modal').classList.contains('hidden');
                const iframeHidden = document.getElementById('iframe-modal').classList.contains('hidden');
                
                if (sidebarActive && modalHidden && iframeHidden) {
                    refreshData(true); 
                } else {
                    stopAutoRefresh(); 
                }
            }, 30000); 
        }

        function stopAutoRefresh() {
            if (STATE.autoRefreshTimer) {
                clearInterval(STATE.autoRefreshTimer);
                STATE.autoRefreshTimer = null;
            }
        }
        
        // --- å®šä½åŠŸèƒ½ --- (RESTRUCTURED)

        // NEW: Handles the silent, one-time location on page load.
        function initialLocate() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    updateUserLocation(pos);
                    STATE.map.flyTo([pos.coords.latitude, pos.coords.longitude], 17, { animate: true, duration: 1.2 });
                }, 
                (err) => { 
                    // Fails silently, no user notification.
                    console.error("Initial silent locate failed:", err.message); 
                }, 
                { timeout: 8000, enableHighAccuracy: true }
            );
        }
        
        // REFACTORED: Updates the user's blue dot marker on the map.
        function updateUserLocation(pos) {
            const { latitude, longitude, accuracy } = pos.coords;
            if (STATE.userAccuracy) STATE.map.removeLayer(STATE.userAccuracy);
            if (STATE.userMarker) STATE.map.removeLayer(STATE.userMarker);
            
            STATE.userAccuracy = L.circle([latitude, longitude], { radius: accuracy, color: '#3b82f6', fillOpacity: 0.1, weight: 1, interactive: false }).addTo(STATE.map);
            STATE.userMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({ className: 'bg-blue-600 border-2 border-white rounded-full shadow-lg', iconSize: [14, 14] })
            }).addTo(STATE.map);
        }

        // REFACTORED: Now only handles continuous, silent background tracking.
        function startContinuousGeolocation() {
            if (!navigator.geolocation) return;
            if (STATE.geoWatcherId) return; // Prevent multiple watchers.
            
            LOCATE_ICON_ELEMENT.innerText = 'gps_fixed';

            const successCallback = (pos) => {
                // Only updates the marker, does NOT move the map.
                updateUserLocation(pos);
            };
            
            const errorCallback = (err) => {
                // Fails silently, no user notification.
                console.error("Background geolocation watch error:", err.message);
                LOCATE_ICON_ELEMENT.innerText = 'my_location';
                if(STATE.geoWatcherId) {
                    navigator.geolocation.clearWatch(STATE.geoWatcherId);
                    STATE.geoWatcherId = null;
                }
            };

            STATE.geoWatcherId = navigator.geolocation.watchPosition(
                successCallback, 
                errorCallback, 
                { timeout: 15000, enableHighAccuracy: true, maximumAge: 0 } 
            );
        }
        
        // REFACTORED: The button click handler with explicit user feedback.
        function locateUser() {
            if (!navigator.geolocation) {
                return showToast('ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'error');
            }
            
            LOCATE_ICON_ELEMENT.classList.add('spin-anim');

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    LOCATE_ICON_ELEMENT.classList.remove('spin-anim');
                    updateUserLocation(pos);
                    STATE.map.flyTo(STATE.userMarker.getLatLng(), 18, { animate: true, duration: 0.8 });
                    showToast('åœ°åœ–å·²é‡æ–°å®šä½åˆ°æ‚¨çš„ä½ç½®', 'info');
                    // Ensure continuous tracking is running after a successful manual locate
                    if (!STATE.geoWatcherId) {
                        startContinuousGeolocation();
                    }
                },
                (err) => {
                    LOCATE_ICON_ELEMENT.classList.remove('spin-anim');
                    // Shows an explicit error message to the user.
                    showToast('ç„¡æ³•å–å¾—æ‚¨çš„å³æ™‚ä½ç½®', 'error');
                },
                { timeout: 8000, enableHighAccuracy: true }
            );
        }

        async function refreshData(isAuto = false) { 
            if (!STATE.currentContext) return;
            
            const btnIcon = document.querySelector('#refresh-btn span');
            const navModal = document.getElementById('nav-modal');
            const iframeModal = document.getElementById('iframe-modal');

            if (!navModal.classList.contains('hidden') || !iframeModal.classList.contains('hidden')) {
                if (!isAuto) showToast('è«‹å…ˆå®Œæˆæ“ä½œå¾Œå†æ›´æ–°è³‡æ–™', 'info');
                return;
            }

            if (!isAuto) { 
                btnIcon.classList.add('spin-anim');
            }
            
            const { type, data } = STATE.currentContext;
            const content = document.getElementById('sb-content');
            let refreshSuccess = false; 

            if (type === 'bus') {
                const busStationId = data.id; 
                if(busStationId) {
                    const arrivals = await getBusArrivals(busStationId);
                    renderBusContent(arrivals, content);
                    if (arrivals) refreshSuccess = true;
                }
            } else if (type === 'bike') {
                const bikeStationNo = data.station_no; 
                if(bikeStationNo) {
                    const info = await getBikeRealtime(bikeStationNo);
                    renderBikeContent(info, content);
                    if (info) refreshSuccess = true;
                }
            }

            if (!isAuto) {
                setTimeout(() => { 
                    btnIcon.classList.remove('spin-anim'); 
                    if (refreshSuccess) {
                        showToast('å³æ™‚è³‡æ–™å·²æ›´æ–°', 'success'); 
                    } else {
                        showToast('è³‡æ–™æ›´æ–°å¤±æ•—', 'error'); 
                    }
                }, 600);
            }
        }

        function initMap() {
            STATE.map = L.map('map', { 
                zoomControl: false, 
                preferCanvas: true 
            }).setView([22.631442, 120.301890], 17);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(STATE.map);
            STATE.map.on('click', () => toggleSidebar(false));

            STATE.busCluster = L.markerClusterGroup({ disableClusteringAtZoom: 17, showCoverageOnHover: false, maxClusterRadius: 60, iconCreateFunction: (c) => L.divIcon({ html: `<div>${c.getChildCount()}</div>`, className: 'marker-cluster marker-cluster-bus', iconSize: [40, 40] }) });
            STATE.bikeCluster = L.markerClusterGroup({ disableClusteringAtZoom: 17, showCoverageOnHover: false, maxClusterRadius: 60, iconCreateFunction: (c) => L.divIcon({ html: `<div>${c.getChildCount()}</div>`, className: 'marker-cluster marker-cluster-ubike', iconSize: [40, 40] }) });

            STATE.map.addLayer(STATE.busCluster);
            STATE.map.addLayer(STATE.bikeCluster);
        }

        // --- è³‡æ–™è¼‰å…¥å‡½å¼ ---
        async function fetchGraphQL(query) {
            try {
                const response = await fetch(CONFIG.IBUS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Origin': 'https://ibus.tbkc.gov.tw', 'Referer': 'https://ibus.tbkc.gov.tw/' },
                    body: JSON.stringify({ query })
                });
                if (!response.ok) { const text = await response.text(); throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`); }
                return await response.json();
            } catch (e) { throw e; }
        }

        async function fetchBusStationsGodMode() {
            const uniqueStations = new Map();
            try {
                const listQuery = `query { routes(lang: "zh") { edges { node { id name } } } }`;
                const listData = await fetchGraphQL(listQuery);
                const allRoutes = listData.data.routes.edges;
                const bigQueryBody = allRoutes.map(edge => `r_${edge.node.id}: route(xno: ${edge.node.id}, lang: "zh") { stations { edges { node { id name lat lon } } } }`).join('\n');
                const godQuery = `query GOD_MODE_FETCH { ${bigQueryBody} }`;
                const result = await fetchGraphQL(godQuery);
                if (result.errors) { console.error(result.errors); throw new Error("ä¼ºæœå™¨å›å‚³éŒ¯èª¤"); }
                if (result.data) {
                    Object.values(result.data).forEach(routeData => {
                        if (routeData && routeData.stations) {
                            routeData.stations.edges.forEach(e => {
                                const s = e.node;
                                if (!uniqueStations.has(s.id)) { if (s.lat && s.lon && s.lat > 0 && s.lon > 0) { uniqueStations.set(s.id, { id: s.id, name: s.name, lat: s.lat, lon: s.lon }); } }
                            });
                        }
                    });
                }
                return Array.from(uniqueStations.values());
            } catch (e) { console.error("God Mode Fetch Failed:", e); showToast(`å…¬è»Šè³‡æ–™æŠ“å–å¤±æ•—: ${e.message.substring(0, 50)}...`, 'error'); updateLoading("ğŸ’¥ å…¬è»Šè³‡æ–™è¼‰å…¥å¤±æ•—"); return []; }
        }

        async function loadBusData() {
            updateLoading('æ­£åœ¨è¼‰å…¥å…¬è»Šç«™é» (2/3)');
            try {
                STATE.dataBus = await fetchBusStationsGodMode(); 
                const markers = STATE.dataBus.map(s => {
                    if(!s.lat || !s.lon) return null;
                    const marker = L.marker([s.lat, s.lon], { icon: L.divIcon({ className: 'custom-icon bus-icon', html: '<span class="material-icons-outlined text-lg">directions_bus</span>', iconSize: [30, 30] }) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bus', s); });
                    STATE.markersMap.bus[s.id] = marker;
                    return marker;
                }).filter(m => m);
                STATE.busCluster.addLayers(markers);
            } catch (e) { console.error(e); }
        }

        async function loadBikeData() {
            updateLoading('æ­£åœ¨è¼‰å…¥ YouBike ç«™é» (3/3)');
            try {
                const res = await fetch(CONFIG.UBIKE_LIST);
                const data = await res.json();
                STATE.dataBike = data.filter(s => s.lat > 22.4 && s.lat < 23.0 && s.lng > 120.1 && s.lng < 120.8);
                const markers = STATE.dataBike.map(s => {
                    const marker = L.marker([s.lat, s.lng], { icon: L.divIcon({ className: 'custom-icon ubike-icon', html: '<span class="material-icons-round text-lg">pedal_bike</span>', iconSize: [30, 30] }) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bike', s); });
                    STATE.markersMap.bike[s.station_no] = marker;
                    return marker;
                }).filter(m => m);
                STATE.bikeCluster.addLayers(markers);
            } catch (e) { console.error(e); }
        }

        function handleMarkerClick(marker, type, data) {
            openSidebar(type, data);
        }

        // --- Sidebar é–‹é—œé‚è¼¯ ---
        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar');
            const isLandscape = window.innerWidth > window.innerHeight;

            if (isLandscape) {
                if (show) sb.classList.add('active');
                else sb.classList.remove('active');
            } else {
                if (show) {
                    sb.classList.add('active');
                    sb.style.height = '60vh'; 
                } else {
                    sb.classList.remove('active');
                    sb.style.height = '0px';
                }
            }
            
            if (show) {
                document.body.classList.add('sidebar-open');
            } else {
                document.body.classList.remove('sidebar-open');
                stopAutoRefresh();
            }
        }

        // --- Sidebar æ‰‹å‹¢é‚è¼¯ ---
        function initSidebarGestures() {
            const sidebarHeader = document.getElementById('sidebar-header');
            const sidebar = document.getElementById('sidebar');
            const searchContainer = document.querySelector('.search-container');
            
            let startY = 0, startHeight = 0, startTime = 0;
            let isDragging = false;
            
            const isLandscape = () => window.innerWidth > window.innerHeight;

            const getMaxHeight = () => {
                const searchRect = searchContainer.getBoundingClientRect();
                return window.innerHeight - (searchRect.bottom + 12);
            };

            sidebarHeader.addEventListener('touchstart', (e) => {
                if (isLandscape() || !sidebar.classList.contains('active')) return;
                
                isDragging = true;
                startY = e.touches[0].clientY;
                startHeight = sidebar.offsetHeight;
                startTime = Date.now();
                sidebar.style.transition = 'none';
            }, { passive: true });

            sidebarHeader.addEventListener('touchmove', (e) => {
                if (!isDragging || isLandscape()) return;
                
                const touchY = e.touches[0].clientY;
                const deltaY = startY - touchY;
                let newHeight = startHeight + deltaY;
                
                const maxHeight = getMaxHeight();
                if (newHeight < 0) newHeight = 0;
                if (newHeight > maxHeight) newHeight = maxHeight;

                sidebar.style.height = `${newHeight}px`;
            }, { passive: true });

            sidebarHeader.addEventListener('touchend', (e) => {
                if (!isDragging || isLandscape()) return;
                isDragging = false;
                
                sidebar.style.transition = 'height 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
                
                const finalHeight = sidebar.offsetHeight;
                const endY = e.changedTouches[0].clientY;
                const duration = Date.now() - startTime;
                
                const velocity = (endY - startY) / duration;

                const isFlickDown = velocity > 0.8;
                const isIntentionallyClosed = finalHeight < window.innerHeight * 0.15;

                if (isFlickDown || isIntentionallyClosed) {
                    toggleSidebar(false);
                } else {
                    sidebar.style.height = `${finalHeight}px`;
                }
            });
        }
        
        async function openSidebar(type, data) {
            const isLandscape = window.innerWidth > window.innerHeight;
            const lat = type === 'bus' ? data.lat : data.lat;
            const lon = type === 'bus' ? data.lon : data.lng;
            const targetLatLng = L.latLng(lat, lon);
            const targetZoom = 18;

            const newId = type === 'bus' ? data.id : data.station_no;
            const isSameMarker = STATE.currentContext &&
                                 document.getElementById('sidebar').classList.contains('active') &&
                                 STATE.currentContext.type === type &&
                                 (type === 'bus' ? STATE.currentContext.data.id === newId : STATE.currentContext.data.station_no === newId);
            
            if (isSameMarker) return;
            
            let panByX = 0;
            let panByY = 0;
            
            if (isLandscape) {
                panByX = -(380 + 12) / 2;
            } else {
                const searchRect = document.querySelector('.search-container').getBoundingClientRect();
                const initialSidebarHeight = window.innerHeight * 0.6;
                const visibleMapHeight = window.innerHeight - initialSidebarHeight;
                const visibleMapCenterY = searchRect.bottom + (visibleMapHeight - searchRect.bottom) / 2;
                panByY = (window.innerHeight / 2) - visibleMapCenterY;
            }

            const targetPoint = STATE.map.project(targetLatLng, targetZoom);
            const newCenterPoint = targetPoint.add(L.point(panByX, panByY));
            const newCenterLatLng = STATE.map.unproject(newCenterPoint, targetZoom);

            STATE.map.flyTo(newCenterLatLng, targetZoom, { animate: true, duration: 1.0 });

            toggleSidebar(true);
            
            STATE.currentContext = { type, data };
            const content = document.getElementById('sb-content');
            const badge = document.getElementById('sb-badge');
            const title = document.getElementById('sb-title');
            const subtitle = document.getElementById('sb-subtitle');

            content.innerHTML = `<div class="animate-pulse space-y-4"><div class="h-24 bg-gray-200 rounded-2xl"></div><div class="h-12 bg-gray-200 rounded-xl"></div></div>`;

            if (type === 'bus') {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 bg-blue-100 text-blue-700';
                badge.innerHTML = '<span class="material-icons-outlined text-sm mr-1">directions_bus</span> å…¬è»Š';
                title.innerText = data.name;
                subtitle.innerText = `ID: ${data.id}`;
                const arrivals = await getBusArrivals(data.id);
                renderBusContent(arrivals, content);
            } else {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 bg-amber-100 text-amber-700';
                badge.innerHTML = '<span class="material-icons-round text-sm mr-1">pedal_bike</span> YouBike 2.0';
                title.innerText = data.name_tw;
                subtitle.innerText = data.address_tw;
                const info = await getBikeRealtime(data.station_no);
                renderBikeContent(info, content);
            }

            startAutoRefresh(); 
        }

        // --- æ¸²æŸ“å‡½å¼ ---
        function renderBusContent(data, container) {
            if (!data) { container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-center text-sm">é€£ç·šå¤±æ•— (CORS) æˆ– iBus æŸ¥è©¢éŒ¯èª¤</div>'; return; }
            if (data.length === 0) { container.innerHTML = '<div class="p-8 text-center text-slate-400"><span class="material-icons-outlined text-4xl mb-2">bus_alert</span><p>ç„¡ç‡Ÿé‹è·¯ç·š</p></div>'; return; }
            const stationId = STATE.currentContext.data.id; 
            let html = '<div class="space-y-3">';
            data.forEach(r => {
                let timeHtml = `<span class="text-gray-400 font-bold text-sm">æœªç™¼è»Š</span>`;
                let statusClass = 'bg-white border-gray-100';
                if (r.isSuspended) timeHtml = `<span class="text-gray-500 text-sm">æœ«ç­å·²é</span>`;
                else if (r.etas?.[0]) {
                    const min = r.etas[0].etaTime;
                    if (min <= 1) { timeHtml = `<span class="text-red-600 font-bold flex items-center text-sm"><span class="material-icons-round text-sm mr-1 animate-pulse">campaign</span>é€²ç«™ä¸­</span>`; statusClass = 'bg-red-50 border-red-100 shadow-sm'; }
                    else if (min <= 3) timeHtml = `<span class="text-red-500 font-bold text-sm">å³å°‡åˆ°ç«™</span>`;
                    else timeHtml = `<span class="text-blue-600 font-bold text-lg">${min} <span class="text-xs font-normal text-slate-500">åˆ†</span></span>`;
                } else if (r.comeTime) timeHtml = `<span class="text-slate-600 font-medium text-sm">${r.comeTime}</span>`;
                html += `<div onclick="confirmRedirect('${r.id}', '${r.name}', '${stationId}')" class="p-3 rounded-2xl border ${statusClass} flex items-center justify-between transition bg-white active:scale-95 cursor-pointer"><div class="flex-1 min-w-0 mr-3"><div class="flex items-center gap-2 flex-nowrap"><span class="text-lg font-bold text-slate-800 truncate min-w-0">${r.name}</span><span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full flex-shrink-0 whitespace-nowrap">${r.dir}</span></div></div><div class="text-right min-w-[80px]">${timeHtml}</div><span class="material-icons-outlined text-slate-300 text-lg ml-2">chevron_right</span></div>`;
            });
            container.innerHTML = html + '</div>';
        }

        function renderBikeContent(info, container) {
            if (!info) { container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-center">ç„¡æ³•å–å¾—å³æ™‚è»Šä½</div>'; return; }
            const yb2 = info.available_spaces_detail.yb2, ybE = info.available_spaces_detail.eyb, empty = info.empty_spaces;
            const time = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
            const getNumColor = (n) => n > 3 ? 'text-slate-800' : (n > 0 ? 'text-orange-600' : 'text-gray-300');
            container.innerHTML = `<div class="space-y-4"><div class="grid grid-cols-2 gap-3"><div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-3xl shadow-sm border border-amber-200 relative overflow-hidden flex flex-col justify-between h-28"><div class="z-10"><span class="text-xs font-bold text-amber-700 uppercase tracking-wider block mb-1">ä¸€èˆ¬è»Šè¼›</span><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(yb2)}">${yb2}</span><span class="text-xs text-amber-800 ml-1 font-medium">è¼›</span></div></div><span class="material-icons-round absolute right-0 bottom-0 text-7xl text-amber-400 opacity-20 transform translate-x-1 translate-y-1">pedal_bike</span></div><div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-3xl shadow-sm border border-orange-200 relative overflow-hidden flex flex-col justify-between h-28"><div class="z-10"><div class="flex items-center justify-between mb-1"><span class="text-xs font-bold text-orange-700 uppercase tracking-wider">é›»è¼”è»Š</span><span class="material-icons-round text-xs text-orange-600">bolt</span></div><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(ybE)}">${ybE}</span><span class="text-xs text-orange-800 ml-1 font-medium">è¼›</span></div></div><span class="material-icons-round absolute right-0 bottom-0 text-7xl text-orange-400 opacity-20 transform translate-x-1 translate-y-1">electric_bike</span></div></div><div class="bg-gradient-to-br from-emerald-50 to-teal-100 p-5 rounded-3xl shadow-sm border border-emerald-200 flex justify-between items-center relative overflow-hidden"><div class="relative z-10"><div class="text-xs text-emerald-800 mb-1 font-bold uppercase tracking-wider">å¯æ­¸é‚„ç©ºä½</div><div class="font-bold text-lg text-emerald-900">åœè»ŠæŸ±</div></div><div class="text-5xl font-black text-emerald-600 relative z-10">${empty}</div><span class="material-icons-outlined absolute right-0 top-0 text-8xl text-emerald-500 opacity-10 transform translate-x-1 -translate-y-1 pointer-events-none">local_parking</span></div><div class="text-center text-xs text-slate-400 mt-2 flex justify-center items-center gap-1"><span class="material-icons-outlined text-sm">schedule</span> æ›´æ–°æ–¼ ${time}</div></div>`;
        }
        
        // --- API å‡½å¼ ---
        async function getBusArrivals(stationId) {
            const qRoute = `query Q($ids:[Int!]!){stations(lang:"zh",ids:$ids){edges{node{... on Station{routes{edges{goBack node{id name}}}}}}}}`;
            const qTime = `query T($t:[EstimateStationInput!]!){stationEstimates(targets:$t){edges{node{comeTime isSuspended etas{etaTime}}}}}`;
            try {
                const r1 = await fetch(CONFIG.IBUS_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query: qRoute, variables: { ids: [parseInt(stationId, 10)] } }) });
                const j1 = await r1.json(); const routeEdges = j1?.data?.stations?.edges?.[0]?.node?.routes?.edges; if (!routeEdges) return []; 
                const targets = routeEdges.map(e => ({ xno: parseInt(e.node.id, 10), goBack: parseInt(e.goBack, 10), stationId: parseInt(stationId, 10) }));
                const r2 = await fetch(CONFIG.IBUS_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query: qTime, variables: { t: targets } }) });
                const j2 = await r2.json(); const estimates = j2.data.stationEstimates.edges;
                return routeEdges.map((e, i) => ({ id: e.node.id, name: e.node.name, dir: e.goBack === 1 ? 'å»ç¨‹' : 'è¿”ç¨‹', ...(estimates[i]?.node || {}) }));
            } catch (e) { console.error("Failed to get bus arrivals:", e); return null; }
        }

        async function getBikeRealtime(id) {
            try {
                const res = await fetch(CONFIG.UBIKE_REALTIME, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ station_no: [id] }) });
                const j = await res.json(); return j.retVal?.data?.[0];
            } catch (e) { return null; }
        }

        // --- æœå°‹åŠŸèƒ½ ---
        const searchInput = document.getElementById('search-input'), resultsBox = document.getElementById('search-results'), searchClear = document.getElementById('search-clear');
        function toggleClearBtn() { if (searchInput.value.length > 0) searchClear.classList.remove('hidden'); else searchClear.classList.add('hidden'); }
        searchInput.addEventListener('input', (e) => { toggleClearBtn(); const val = e.target.value.trim().toLowerCase(); if(val) doSearch(val); else resultsBox.classList.remove('show'); });
        searchInput.addEventListener('click', () => { const val = searchInput.value.trim().toLowerCase(); if(val) doSearch(val); });
        searchInput.addEventListener('focus', () => { const val = searchInput.value.trim().toLowerCase(); if(val) doSearch(val); });
        searchClear.addEventListener('click', () => { searchInput.value = ''; toggleClearBtn(); resultsBox.classList.remove('show'); searchInput.focus(); });
        function calculateScore(item, key) {
            const nKey = key.toLowerCase(), type = item.id ? 'bus' : 'bike'; let name, sub;
            if (type === 'bus') { name = item.name; sub = item.id.toString(); } else { name = item.name_tw; sub = item.address_tw; }
            const nName = name.toLowerCase(), nSub = sub.toLowerCase(); let score = 0;
            if (nName === nKey) score = 1000;
            else if (nName.startsWith(nKey)) score = 800 + 100 - nName.length; 
            else if (nName.includes(nKey)) score = 500 + 50 - nName.indexOf(nKey); 
            else if (nSub.includes(nKey)) score = 200 + 50 - nSub.indexOf(nKey); 
            return score;
        }
        function doSearch(key) {
            resultsBox.innerHTML = ''; const allResults = [];
            STATE.dataBus.forEach(s => { const score = calculateScore(s, key); if (score > 0) allResults.push({ type: 'bus', data: s, score: score }); });
            STATE.dataBike.forEach(s => { const score = calculateScore(s, key); if (score > 0) allResults.push({ type: 'bike', data: s, score: score }); });
            allResults.sort((a, b) => b.score - a.score); const finalResults = allResults.slice(0, 15); 
            if(finalResults.length === 0) { resultsBox.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">æ‰¾ä¸åˆ°ç›¸é—œç«™é»</div>'; } else { finalResults.forEach(r => appendResult(r.type, r.data)); }
            resultsBox.classList.add('show');
        }
        function appendResult(type, data) {
            const div = document.createElement('div'); const name = type === 'bus' ? data.name : data.name_tw, sub = type === 'bus' ? `ID: ${data.id}` : data.address_tw;
            const icon = type === 'bus' ? 'directions_bus' : 'pedal_bike', color = type === 'bus' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600';
            div.className = 'p-3 flex items-center hover:bg-slate-50 cursor-pointer border-b border-gray-50 last:border-0 transition';
            div.innerHTML = `<div class="w-10 h-10 rounded-full ${color} flex items-center justify-center mr-3 shrink-0"><span class="material-icons-outlined text-lg">${icon}</span></div><div class="min-w-0"><div class="font-bold text-slate-700 text-sm truncate">${name}</div><div class="text-xs text-slate-400 truncate">${sub}</div></div>`;
            div.onclick = () => {
                resultsBox.classList.remove('show'); searchInput.value = name; toggleClearBtn();
                const id = type === 'bus' ? data.id : data.station_no, markerMap = type === 'bus' ? STATE.markersMap.bus : STATE.markersMap.bike, cluster = type === 'bus' ? STATE.busCluster : STATE.bikeCluster;
                if (markerMap[id]) { cluster.zoomToShowLayer(markerMap[id], () => handleMarkerClick(markerMap[id], type, data)); } 
                else { handleMarkerClick(null, type, data); }
            };
            resultsBox.appendChild(div);
        }
        document.addEventListener('click', (e) => { if (!document.querySelector('.search-container').contains(e.target)) resultsBox.classList.remove('show'); });
    </script>
</body>
</html>
