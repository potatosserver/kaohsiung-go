<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>高雄交通智慧地圖</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 全域設定：禁止選取文字 */
        body, html { 
            height: 100%; margin: 0; overflow: hidden; 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f3f4f6;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #map { height: 100%; width: 100%; z-index: 1; }

        /* --- 圖釘與聚合樣式 --- */
        .custom-icon {
            border: 3px solid white; border-radius: 50%; color: white;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4); 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .custom-icon:hover { transform: scale(1.2); z-index: 1000 !important; }
        .bus-icon { background: #2563eb; }
        .ubike-icon { background: #f59e0b; }

        .marker-cluster-bus { background-color: rgba(59, 130, 246, 0.5) !important; }
        .marker-cluster-bus div { background-color: #1d4ed8 !important; color: white !important; border-radius: 50%; width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; line-height: 30px; font-weight: bold; }
        .marker-cluster-ubike { background-color: rgba(245, 158, 11, 0.5) !important; }
        .marker-cluster-ubike div { background-color: #d97706 !important; color: white !important; border-radius: 50%; width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; line-height: 30px; font-weight: bold; }

        /* --- 搜尋欄 --- */
        .search-container { 
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; width: 94%; max-width: 400px;
        }
        
        #search-box {
            background: white; border-radius: 99px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex; align-items: center; padding: 0.5rem 1rem;
            transition: all 0.3s;
        }

        #search-results {
            background: white; width: 100%; margin-top: 8px; border-radius: 16px;
            max-height: 50vh; overflow-y: auto; display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
        }
        #search-results.show { display: block; }

        /* --- 側邊欄與 RWD --- */
        #sidebar {
            position: fixed; z-index: 2000; background: white;
            box-shadow: 0 0 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* 手機版 */
        @media (max-width: 767px) {
            #sidebar {
                left: 0; bottom: 0; width: 100%; height: 65vh;
                border-radius: 28px 28px 0 0;
                transform: translateY(105%); touch-action: none;
            }
            #sidebar.active { transform: translateY(0); }
        }

        /* 電腦版 */
        @media (min-width: 768px) {
            #sidebar {
                top: 12px; left: 12px; height: calc(100% - 24px); width: 380px;
                transform: translateX(-110%);
                border-radius: 24px; border: 1px solid #e5e7eb;
            }
            #sidebar.active { transform: translateX(0); }

            .search-container {
                top: 20px; left: 20px; width: 380px; max-width: none;
                transform: none; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            }
            body.sidebar-open .search-container { transform: translateX(410px); }
        }
        
        /* 載入動畫 */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        #loading-screen.visible { pointer-events: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-anim { animation: spin 0.8s linear infinite; }

        /* Toast 通知 */
        #toast-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            z-index: 4000; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;
            width: 90%; max-width: 300px; display: flex; justify-content: center;
        }
        #toast-container.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-content {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            color: #1e293b; padding: 10px 20px; border-radius: 99px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0;
        }

        /* 跳轉確認彈窗 */
        #nav-modal { transition: opacity 0.3s ease; }
        #nav-modal.hidden { opacity: 0; pointer-events: none; }
        #nav-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

    <!-- 載入畫面 -->
    <div id="loading-screen" class="visible">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-slate-800">高雄交通智慧地圖</h2>
        <p id="loading-text" class="text-sm text-slate-500 mt-2">系統初始化中...</p>
    </div>

    <!-- Toast 通知 -->
    <div id="toast-container">
        <div id="toast-message" class="toast-content">
            <span id="toast-icon" class="material-icons-round text-lg">info</span>
            <span id="toast-text">提示訊息</span>
        </div>
    </div>

    <!-- 跳轉確認彈窗 (點擊背景可關閉) -->
    <div id="nav-modal" class="fixed inset-0 z-[5000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden p-4" onclick="handleModalClick(event)">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons-round text-xl">directions_bus</span>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-800">查看路線動態</h3>
                    <p class="text-sm text-slate-500">將前往外部頁面</p>
                </div>
            </div>
            <p class="text-slate-600 mb-6">
                是否查看 <span id="nav-route-name" class="font-bold text-blue-600">紅53</span> 的詳細動態？
            </p>
            <div class="flex gap-3">
                <button onclick="cancelRedirect()" class="flex-1 py-3 px-4 rounded-xl bg-gray-100 text-slate-700 font-bold hover:bg-gray-200 transition">取消</button>
                <button onclick="doRedirect()" class="flex-1 py-3 px-4 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">前往</button>
            </div>
        </div>
    </div>

    <!-- 搜尋欄 -->
    <div class="search-container">
        <div id="search-box">
            <span class="material-icons-outlined text-slate-400 mr-2">search</span>
            <input type="text" id="search-input" placeholder="搜尋公車路線或 YouBike..." 
                   class="flex-1 outline-none text-slate-700 placeholder-slate-400 bg-transparent text-base">
            
            <!-- 清除按鈕 -->
            <button id="search-clear" class="hidden p-1 text-slate-300 hover:text-slate-500 hover:bg-slate-100 rounded-full transition mr-1 flex items-center justify-center">
                <span class="material-icons-round text-lg">cancel</span>
            </button>
            
            <div class="w-[1px] h-5 bg-gray-200 mx-1"></div>
            
            <button class="p-2 text-slate-400 hover:text-blue-600 transition" onclick="locateUser()" title="定位">
                <span class="material-icons-outlined">my_location</span>
            </button>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- 側邊欄 -->
    <div id="sidebar">
        <div id="drag-area" class="bg-white sticky top-0 z-10 cursor-grab active:cursor-grabbing rounded-t-[28px]">
            <div class="w-full flex justify-center pt-3 pb-1 md:hidden">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-start">
                <div class="flex-1 min-w-0 pr-2">
                    <div id="sb-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 transition-colors bg-gray-100 text-gray-600">載入中</div>
                    <h2 id="sb-title" class="text-2xl font-bold text-slate-800 leading-tight truncate">請選擇站點</h2>
                    <div class="flex items-center mt-1 text-slate-500">
                        <span class="material-icons-outlined text-sm mr-1">place</span>
                        <p id="sb-subtitle" class="text-sm truncate">-</p>
                    </div>
                </div>
                <!-- 重新整理按鈕 -->
                <button id="refresh-btn" onclick="refreshData()" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-500 hover:bg-blue-50 hover:text-blue-600 rounded-full transition shadow-sm border border-slate-100" title="更新即時資料">
                    <span class="material-icons-round text-xl">refresh</span>
                </button>
            </div>
        </div>
        <div id="sb-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 space-y-3 pb-safe rounded-b-[28px]"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        const CONFIG = {
            BUS_JSON: 'https://raw.githubusercontent.com/potatosserver/kaohsiung_live_bus/main/Station.json',
            UBIKE_LIST: 'https://apis.youbike.com.tw/json/station-min-yb2.json',
            UBIKE_REALTIME: 'https://apis.youbike.com.tw/tw2/parkingInfo',
            IBUS_API: 'https://ibus.tbkc.gov.tw/ibus/graphql'
        };

        const STATE = {
            map: null, busCluster: null, bikeCluster: null,
            dataBus: [], dataBike: [], markersMap: { bus: {}, bike: {} },
            currentContext: null, pendingRouteId: null
        };

        window.onload = async () => {
            initMap();
            initSidebarGestures();
            await Promise.all([loadBusData(), loadBikeData()]);
            const loading = document.getElementById('loading-screen');
            loading.style.opacity = '0';
            loading.classList.remove('visible');
            setTimeout(() => loading.remove(), 500);
        };

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const text = document.getElementById('toast-text');
            const icon = document.getElementById('toast-icon');
            text.innerText = msg;
            
            if (type === 'error') { icon.innerText = 'error'; icon.className = 'material-icons-round text-red-500 text-xl'; } 
            else if (type === 'success') { icon.innerText = 'check_circle'; icon.className = 'material-icons-round text-green-500 text-xl'; } 
            else { icon.innerText = 'info'; icon.className = 'material-icons-round text-blue-500 text-xl'; }

            container.classList.add('show');
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { container.classList.remove('show'); }, 3000);
        }

        // --- 彈窗與跳轉邏輯 ---
        function confirmRedirect(routeId, routeName) {
            STATE.pendingRouteId = routeId;
            document.getElementById('nav-route-name').innerText = routeName;
            document.getElementById('nav-modal').classList.remove('hidden');
            // 加入歷史紀錄以攔截返回鍵
            history.pushState({ modal: 'nav' }, null, '');
        }

        function doRedirect() {
            if (STATE.pendingRouteId) window.location.href = `https://kaohsiung-live-bus.pages.dev/?page=tracker&route=${STATE.pendingRouteId}`;
        }

        function cancelRedirect() { history.back(); }

        // 點擊彈窗背景關閉
        function handleModalClick(e) {
            if (e.target.id === 'nav-modal') cancelRedirect();
        }

        window.addEventListener('popstate', (e) => {
            const modal = document.getElementById('nav-modal');
            if (!modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                STATE.pendingRouteId = null;
            }
        });

        // --- 定位 ---
        function locateUser() {
            if (!navigator.geolocation) return showToast('瀏覽器不支援定位', 'error');
            showToast('定位中...');
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                STATE.map.flyTo([latitude, longitude], 16);
                if (STATE.userMarker) STATE.map.removeLayer(STATE.userMarker);
                if (STATE.userAccuracy) STATE.map.removeLayer(STATE.userAccuracy);
                STATE.userAccuracy = L.circle([latitude, longitude], { radius: pos.coords.accuracy, color: '#3b82f6', fillOpacity: 0.1 }).addTo(STATE.map);
                STATE.userMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({ className: 'bg-blue-600 border-2 border-white rounded-full shadow-lg pulse-ring', iconSize: [14, 14] })
                }).addTo(STATE.map);
                showToast('定位成功', 'success');
            }, (err) => showToast('無法定位', 'error'), { timeout: 10000, enableHighAccuracy: true });
        }

        // --- 側邊欄重整 ---
        async function refreshData() {
            if (!STATE.currentContext) return;
            const btnIcon = document.querySelector('#refresh-btn span');
            btnIcon.classList.add('spin-anim');
            const { type, data } = STATE.currentContext;
            const content = document.getElementById('sb-content');
            if (type === 'bus') {
                const arrivals = await getBusArrivals(data.id);
                renderBusContent(arrivals, content);
            } else {
                const info = await getBikeRealtime(data.station_no);
                renderBikeContent(info, content);
            }
            setTimeout(() => { btnIcon.classList.remove('spin-anim'); showToast('即時資料已更新', 'success'); }, 600);
        }

        function initMap() {
            STATE.map = L.map('map', { zoomControl: false }).setView([22.6273, 120.3014], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(STATE.map);
            L.control.zoom({ position: 'bottomright' }).addTo(STATE.map);
            STATE.map.on('click', () => toggleSidebar(false));

            STATE.busCluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 60, iconCreateFunction: (c) => L.divIcon({ html: `<div>${c.getChildCount()}</div>`, className: 'marker-cluster marker-cluster-bus', iconSize: [40, 40] }) });
            STATE.bikeCluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 60, iconCreateFunction: (c) => L.divIcon({ html: `<div>${c.getChildCount()}</div>`, className: 'marker-cluster marker-cluster-ubike', iconSize: [40, 40] }) });

            STATE.map.addLayer(STATE.busCluster);
            STATE.map.addLayer(STATE.bikeCluster);
        }

        async function loadBusData() {
            try {
                const res = await fetch(CONFIG.BUS_JSON);
                STATE.dataBus = await res.json();
                const markers = STATE.dataBus.map(s => {
                    if(!s.lat || !s.lon) return null;
                    const marker = L.marker([s.lat, s.lon], { icon: L.divIcon({ className: 'custom-icon bus-icon', html: '<span class="material-icons-outlined text-sm">directions_bus</span>', iconSize: [30, 30] }) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bus', s); });
                    STATE.markersMap.bus[s.id] = marker;
                    return marker;
                }).filter(m => m);
                STATE.busCluster.addLayers(markers);
            } catch (e) { console.error(e); }
        }

        async function loadBikeData() {
            updateLoading('載入 YouBike...');
            try {
                const res = await fetch(CONFIG.UBIKE_LIST);
                const data = await res.json();
                STATE.dataBike = data.filter(s => s.lat > 22.4 && s.lat < 23.0 && s.lng > 120.1 && s.lng < 120.8);
                const markers = STATE.dataBike.map(s => {
                    const marker = L.marker([s.lat, s.lng], { icon: L.divIcon({ className: 'custom-icon ubike-icon', html: '<span class="material-icons-round text-sm">pedal_bike</span>', iconSize: [28, 28] }) });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(marker, 'bike', s); });
                    STATE.markersMap.bike[s.station_no] = marker;
                    return marker;
                }).filter(m => m);
                STATE.bikeCluster.addLayers(markers);
            } catch (e) { console.error(e); }
        }

        function handleMarkerClick(marker, type, data) {
            const lat = type === 'bus' ? data.lat : data.lat;
            const lon = type === 'bus' ? data.lon : data.lng;
            STATE.map.flyTo([lat, lon], 17, { animate: true, duration: 0.8 });
            openSidebar(type, data);
        }

        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar');
            sb.style.transform = '';
            if (show) { sb.classList.add('active'); document.body.classList.add('sidebar-open'); }
            else { sb.classList.remove('active'); document.body.classList.remove('sidebar-open'); }
        }

        function initSidebarGestures() {
            const sidebar = document.getElementById('sidebar');
            const dragArea = document.getElementById('drag-area');
            let startY = 0, currentY = 0, isDragging = false;

            dragArea.addEventListener('touchstart', (e) => {
                if (window.innerWidth >= 768) return;
                startY = e.touches[0].clientY;
                isDragging = true;
                sidebar.style.transition = 'none';
            }, { passive: true });

            dragArea.addEventListener('touchmove', (e) => {
                if (!isDragging || window.innerWidth >= 768) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) sidebar.style.transform = `translateY(${diff}px)`;
            }, { passive: true });

            dragArea.addEventListener('touchend', (e) => {
                if (!isDragging || window.innerWidth >= 768) return;
                isDragging = false;
                sidebar.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)';
                if ((currentY - startY) > 100) toggleSidebar(false);
                else sidebar.style.transform = '';
            });
        }

        async function openSidebar(type, data) {
            toggleSidebar(true);
            STATE.currentContext = { type, data };
            const content = document.getElementById('sb-content');
            const badge = document.getElementById('sb-badge');
            const title = document.getElementById('sb-title');
            const subtitle = document.getElementById('sb-subtitle');

            content.innerHTML = `<div class="animate-pulse space-y-4"><div class="h-24 bg-gray-200 rounded-2xl"></div><div class="h-12 bg-gray-200 rounded-xl"></div></div>`;

            if (type === 'bus') {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 bg-blue-100 text-blue-700';
                badge.innerHTML = '<span class="material-icons-outlined text-sm mr-1">directions_bus</span> 公車';
                title.innerText = data.name;
                subtitle.innerText = `ID: ${data.id}`;
                const arrivals = await getBusArrivals(data.id);
                renderBusContent(arrivals, content);
            } else {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold mb-2 bg-amber-100 text-amber-700';
                badge.innerHTML = '<span class="material-icons-round text-sm mr-1">pedal_bike</span> YouBike 2.0';
                title.innerText = data.name_tw;
                subtitle.innerText = data.address_tw;
                const info = await getBikeRealtime(data.station_no);
                renderBikeContent(info, content);
            }
        }

        function renderBusContent(data, container) {
            if (!data) { container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-center text-sm">連線失敗 (CORS)</div>'; return; }
            if (data.length === 0) { container.innerHTML = '<div class="p-8 text-center text-slate-400"><span class="material-icons-outlined text-4xl mb-2">bus_alert</span><p>無營運路線</p></div>'; return; }
            let html = '<div class="space-y-3">';
            data.forEach(r => {
                let timeHtml = `<span class="text-gray-400 font-bold text-sm">未發車</span>`;
                let statusClass = 'bg-white border-gray-100';
                if (r.isSuspended) timeHtml = `<span class="text-gray-500 text-sm">停駛</span>`;
                else if (r.etas?.[0]) {
                    const min = r.etas[0].etaTime;
                    if (min <= 1) { timeHtml = `<span class="text-red-600 font-bold flex items-center text-sm"><span class="material-icons-round text-sm mr-1 animate-pulse">campaign</span>進站中</span>`; statusClass = 'bg-red-50 border-red-100 shadow-sm'; }
                    else if (min <= 3) timeHtml = `<span class="text-red-500 font-bold text-sm">即將到站</span>`;
                    else timeHtml = `<span class="text-blue-600 font-bold text-lg">${min} <span class="text-xs font-normal text-slate-500">分</span></span>`;
                } else if (r.comeTime) timeHtml = `<span class="text-slate-600 font-medium text-sm">${r.comeTime}</span>`;
                
                html += `
                    <div onclick="confirmRedirect('${r.id}', '${r.name}')" class="p-3 rounded-2xl border ${statusClass} flex items-center justify-between transition bg-white active:scale-95 cursor-pointer">
                        <div class="flex-1 min-w-0 mr-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-slate-800">${r.name}</span>
                                <span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">${r.dir}</span>
                            </div>
                        </div>
                        <div class="text-right min-w-[80px]">${timeHtml}</div>
                        <span class="material-icons-outlined text-slate-300 text-lg ml-2">chevron_right</span>
                    </div>`;
            });
            container.innerHTML = html + '</div>';
        }

        function renderBikeContent(info, container) {
            if (!info) { container.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-center">無法取得即時車位</div>'; return; }
            const yb2 = info.available_spaces_detail.yb2;
            const ybE = info.available_spaces_detail.eyb;
            const empty = info.empty_spaces;
            const time = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
            const getNumColor = (n) => n > 3 ? 'text-slate-800' : (n > 0 ? 'text-orange-600' : 'text-gray-300');

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-3xl shadow-sm border border-amber-200 relative overflow-hidden flex flex-col justify-between h-28">
                            <div class="z-10"><span class="text-xs font-bold text-amber-700 uppercase tracking-wider block mb-1">一般車輛</span><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(yb2)}">${yb2}</span><span class="text-xs text-amber-800 ml-1 font-medium">輛</span></div></div>
                            <span class="material-icons-round absolute -right-3 -bottom-3 text-7xl text-amber-400 opacity-20">pedal_bike</span>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-3xl shadow-sm border border-orange-200 relative overflow-hidden flex flex-col justify-between h-28">
                            <div class="z-10"><div class="flex items-center justify-between mb-1"><span class="text-xs font-bold text-orange-700 uppercase tracking-wider">電輔車</span><span class="material-icons-round text-xs text-orange-600">bolt</span></div><div class="flex items-baseline"><span class="text-4xl font-black ${getNumColor(ybE)}">${ybE}</span><span class="text-xs text-orange-800 ml-1 font-medium">輛</span></div></div>
                            <span class="material-icons-round absolute -right-3 -bottom-3 text-7xl text-orange-400 opacity-20">electric_bike</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-teal-100 p-5 rounded-3xl shadow-sm border border-emerald-200 flex justify-between items-center relative overflow-hidden">
                        <div class="relative z-10"><div class="text-xs text-emerald-800 mb-1 font-bold uppercase tracking-wider">可歸還空位</div><div class="font-bold text-lg text-emerald-900">停車柱</div></div>
                        <div class="text-5xl font-black text-emerald-600 relative z-10">${empty}</div>
                        <span class="material-icons-outlined absolute right-0 top-0 text-9xl text-emerald-500 opacity-10 transform translate-x-4 -translate-y-2 pointer-events-none">local_parking</span>
                    </div>
                    <div class="text-center text-xs text-slate-400 mt-2 flex justify-center items-center gap-1"><span class="material-icons-outlined text-sm">schedule</span> 更新於 ${time}</div>
                </div>`;
        }

        async function getBusArrivals(stationId) {
            const qRoute = `query Q($ids:[Int!]!){stations(lang:"zh",ids:$ids){edges{node{... on Station{routes{edges{goBack node{id name}}}}}}}}`;
            const qTime = `query T($t:[EstimateStationInput!]!){stationEstimates(targets:$t){edges{node{comeTime isSuspended etas{etaTime}}}}}`;
            try {
                const r1 = await fetch(CONFIG.IBUS_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query: qRoute, variables: { ids: [parseInt(stationId, 10)] } }) });
                const j1 = await r1.json();
                const routeEdges = j1?.data?.stations?.edges?.[0]?.node?.routes?.edges;
                if (!routeEdges) return [];
                const targets = routeEdges.map(e => ({ xno: parseInt(e.node.id, 10), goBack: parseInt(e.goBack, 10), stationId: parseInt(stationId, 10) }));
                const r2 = await fetch(CONFIG.IBUS_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query: qTime, variables: { t: targets } }) });
                const j2 = await r2.json();
                const estimates = j2.data.stationEstimates.edges;
                return routeEdges.map((e, i) => ({ id: e.node.id, name: e.node.name, dir: e.goBack === 1 ? '去程' : '返程', ...estimates[i]?.node }));
            } catch (e) { return null; }
        }

        async function getBikeRealtime(id) {
            try {
                const res = await fetch(CONFIG.UBIKE_REALTIME, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ station_no: [id] }) });
                const j = await res.json();
                return j.retVal?.data?.[0];
            } catch (e) { return null; }
        }

        const searchInput = document.getElementById('search-input');
        const resultsBox = document.getElementById('search-results');
        const searchClear = document.getElementById('search-clear');

        // --- 搜尋欄互動邏輯 (核心修復) ---
        function toggleClearBtn() {
            if (searchInput.value.length > 0) searchClear.classList.remove('hidden');
            else searchClear.classList.add('hidden');
        }

        searchInput.addEventListener('input', (e) => {
            toggleClearBtn();
            const val = e.target.value.trim().toLowerCase();
            if(val) doSearch(val);
            else resultsBox.classList.remove('show');
        });

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            toggleClearBtn();
            resultsBox.classList.remove('show');
            searchInput.focus();
        });

        function doSearch(key) {
            resultsBox.innerHTML = '';
            const resBus = STATE.dataBus.filter(s => s.name.includes(key) || s.id.toString().includes(key)).slice(0, 8);
            const resBike = STATE.dataBike.filter(s => s.name_tw.includes(key) || s.address_tw.includes(key)).slice(0, 8);
            if(resBus.length === 0 && resBike.length === 0) { resultsBox.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">找不到相關站點</div>'; }
            else { resBus.forEach(s => appendResult('bus', s)); resBike.forEach(s => appendResult('bike', s)); }
            resultsBox.classList.add('show');
        }

        function appendResult(type, data) {
            const div = document.createElement('div');
            const name = type === 'bus' ? data.name : data.name_tw;
            const sub = type === 'bus' ? `ID: ${data.id}` : data.address_tw;
            const icon = type === 'bus' ? 'directions_bus' : 'pedal_bike';
            const color = type === 'bus' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600';
            div.className = 'p-3 flex items-center hover:bg-slate-50 cursor-pointer border-b border-gray-50 last:border-0 transition';
            div.innerHTML = `<div class="w-10 h-10 rounded-full ${color} flex items-center justify-center mr-3 shrink-0"><span class="material-icons-outlined text-lg">${icon}</span></div><div class="min-w-0"><div class="font-bold text-slate-700 text-sm truncate">${name}</div><div class="text-xs text-slate-400 truncate">${sub}</div></div>`;
            div.onclick = () => {
                resultsBox.classList.remove('show');
                searchInput.value = name;
                toggleClearBtn(); // 確保文字填入後 X 會出現
                const id = type === 'bus' ? data.id : data.station_no;
                const markerMap = type === 'bus' ? STATE.markersMap.bus : STATE.markersMap.bike;
                const cluster = type === 'bus' ? STATE.busCluster : STATE.bikeCluster;
                STATE.map.flyTo([type === 'bus' ? data.lat : data.lat, type === 'bus' ? data.lon : data.lng], 18, { animate: true, duration: 0.8 });
                if (markerMap[id]) cluster.zoomToShowLayer(markerMap[id], () => openSidebar(type, data));
            };
            resultsBox.appendChild(div);
        }
        function updateLoading(txt) { document.getElementById('loading-text').innerText = txt; }
    </script>
</body>
</html>